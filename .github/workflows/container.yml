name: Deploy Images to GHCR

on:
  push:
    tags:
      - v*
  workflow_dispatch:

jobs:
  push-container-image:
    runs-on: ubuntu-latest
    steps:
     - uses: actions/checkout@main
     - name: Install Nix
       uses: cachix/install-nix-action@v22
       with:
         github_access_token: ${{ secrets.GITHUB_TOKEN }}
     - name: Build container image
       run: nix build .#streamedContainer
     - name: 'Login to GitHub Container Registry'
       uses: docker/login-action@v3
       with:
         registry: ghcr.io
         username: ${{ github.actor }}
         password: ${{ secrets.GITHUB_TOKEN }}
     - name: 'Push Container Image'
       run: |
         ./result | docker load
         docker tag stable-diffusion-bot:latest ghcr.io/capslock/stable-diffusion-bot:latest
         docker push ghcr.io/capslock/stable-diffusion-bot:latest
